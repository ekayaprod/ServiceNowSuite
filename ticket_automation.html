<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Automation - ServiceNow Bookmarklet Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; }
        .toast { background-color: #22c55e; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body class="bg-slate-100">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="container w-full max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-800">Universal Automation Builder</h1>
                <p class="text-slate-600 mt-2">Generate a powerful on-page tool to build any automation you need.</p>
                <a href="ticket_template.html" class="text-blue-600 hover:underline mt-2 inline-block">&larr; Back to Tools</a>
            </header>

            <main id="app-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="step1" class="step active">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-6">Generate Your Builder</h2>
                    <div class="space-y-6">
                         <div class="p-4 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-sm">
                            Click the button below to generate a **Builder Bookmarklet**. Drag it to your bookmarks bar. When you're on a ServiceNow form, click the bookmarklet to open a powerful rule engine and create custom automation tools.
                        </div>
                        <div>
                            <label for="bookmarkletName" class="block text-sm font-medium text-slate-700">Builder Bookmarklet Name</label>
                            <input type="text" id="bookmarkletName" value="Automation Builder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="generateBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Generate Automation Builder</button>
                    </div>
                </div>

                <div id="step2" class="step"></div>
            </main>
        </div>
    </div>
    <div id="toast-container"></div>

<script>
function showToast(message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

document.getElementById('generateBtn').addEventListener('click', () => {
    const name = document.getElementById('bookmarkletName').value.trim() || 'Automation Builder';

    // This is the entire, minified script for the on-page builder tool.
    const builderScript = `javascript:(async()=>{const findEnv=w=>{try{function findFS(n){let f=n.querySelector('#gsft_main,iframe[name="gsft_main"]');if(f)return f;const a=n.querySelectorAll('*');for(const e of a)if(e.shadowRoot&&(f=findFS(e.shadowRoot)))return f;return null}function getE(t){if(!t)return null;if(t.g_form&&typeof t.g_form.getTableName==='function')return{type:'form',ctx:{w:t,g:t.g_form}};const l=t.document.querySelector('#task_table,.list_table,[data-list_id]');if(l)return{type:'list',ctx:{w:t,l}};return null}const fe=findFS(w.document);if(fe&&fe.contentWindow){const fv=getE(fe.contentWindow);if(fv)return fv}return getE(w)}catch(e){console.error('Err:',e)}return null};const env=findEnv(window.top);if(!env||env.type!=='form')return alert('Please run the Automation Builder on a ServiceNow form page.');const builder={win:env.ctx.w,g:env.ctx.g,pId:'automation-builder-'+Date.now(),f:[],c:[],a:[],init(){if(this.win.document.getElementById(this.pId))return;this.sF();this.bUI()},sF(){const m=new Map();this.f=this.g.elements.map(e=>{const n=e.fieldName;if(m.has(n)||!this.g.getField(n)?.visible)return null;m.set(n,!0);return{n,l:this.g.getLabelOf(n)||n}}).filter(Boolean).sort((x,y)=>x.l.localeCompare(y.l))},bUI(){const h=\`<div id="\${this.pId}" style="position:fixed;top:5%;left:50%;transform:translateX(-50%);width:90%;max-width:800px;background:#fff;color:#000;border-radius:12px;box-shadow:0 8px 32px #0005;z-index:999999;font-family:sans-serif;display:flex;flex-direction:column;max-height:90vh"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Automation Builder</h3><div style="padding:20px;overflow-y:auto;flex-grow:1"><div style="margin-bottom:20px"><h4 style="margin:0 0 10px;font-size:1.1em;border-bottom:1px solid #eee;padding-bottom:5px">Conditions (IF)</h4><div id="\${this.pId}-c"></div><button id="\${this.pId}-add-c" style="margin-top:10px;padding:6px 12px;background:#eef;border:1px solid #ccf;color:#339;border-radius:4px;cursor:pointer">+ Add</button></div><div><h4 style="margin:0 0 10px;font-size:1.1em;border-bottom:1px solid #eee;padding-bottom:5px">Actions (THEN)</h4><div id="\${this.pId}-a"></div><button id="\${this.pId}-add-a" style="margin-top:10px;padding:6px 12px;background:#efe;border:1px solid #cfc;color:#393;border-radius:4px;cursor:pointer">+ Add</button></div></div><div id="\${this.pId}-res" style="display:none;padding:0 20px 20px;"></div><div style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:flex-end;gap:10px"><button id="\${this.pId}-close">Close</button><button id="\${this.pId}-gen" style="background:#0066cc;color:white;padding:8px 16px;border:none;border-radius:6px">Generate</button></div></div>\`;this.win.document.body.insertAdjacentHTML('beforeend',h);this.win.document.getElementById(this.pId+'-add-c').onclick=()=>this.addR('c');this.win.document.getElementById(this.pId+'-add-a').onclick=()=>this.addR('a');this.win.document.getElementById(this.pId+'-close').onclick=()=>this.close();this.win.document.getElementById(this.pId+'-gen').onclick=()=>this.genF();this.rR()},rR(){const cC=this.win.document.getElementById(this.pId+'-c'),aC=this.win.document.getElementById(this.pId+'-a'),fO=this.f.map(f=>\`<option value="\${f.n}">\${f.l}</option>\`).join('');cC.innerHTML=this.c.length?this.c.map((c,i)=>this.rC(c,i,fO)).join(''):'<p style="text-align:center;color:#666;font-size:.9em;padding:10px">No conditions. Actions will always run.</p>';aC.innerHTML=this.a.length?this.a.map((a,i)=>this.rA(a,i,fO)).join(''):'<p style="text-align:center;color:#666;font-size:.9em;padding:10px">No actions.</p>'},rC(c,i,fO){return \`<div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #f0f0f0"><select data-i="\${i}" data-t="c" data-k="f" style="flex:2;padding:6px;border-radius:4px;border:1px solid #ccc"><option value="">Select Field</option>\${fO.replace('value="'+c.f+'"','value="'+c.f+'" selected')}</select><select data-i="\${i}" data-t="c" data-k="o" style="flex:1;padding:6px;border-radius:4px;border:1px solid #ccc"><option value="c" \${c.o==='c'?'selected':''}>contains</option><option value="d" \${c.o==='d'?'selected':''}>does not contain</option><option value="i" \${c.o==='i'?'selected':''}>is</option><option value="n" \${c.o==='n'?'selected':''}>is not</option><option value="e" \${c.o==='e'?'selected':''}>is empty</option><option value="f" \${c.o==='f'?'selected':''}>is in future</option></select><input type="text" value="\${c.v||''}" data-i="\${i}" data-t="c" data-k="v" placeholder="Value" style="flex:2;padding:6px;border-radius:4px;border:1px solid #ccc;\${['e','f'].includes(c.o)?'visibility:hidden;':''}"/><button data-i="\${i}" data-t="c" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px">X</button></div>\`},rA(a,i,fO){return \`<div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #f0f0f0"><select data-i="\${i}" data-t="a" data-k="t" style="flex:1;padding:6px;border-radius:4px;border:1px solid #ccc"><option value="s" \${a.t==='s'?'selected':''}>Set Field</option><option value="p" \${a.t==='p'?'selected':''}>Append to Title</option></select><select data-i="\${i}" data-t="a" data-k="f" style="flex:2;padding:6px;border-radius:4px;border:1px solid #ccc"><option value="">Select Field</option>\${fO.replace('value="'+a.f+'"','value="'+a.f+'" selected')}</select><input type="text" value="\${a.v||''}" data-i="\${i}" data-t="a" data-k="v" placeholder="Value" style="flex:2;padding:6px;border-radius:4px;border:1px solid #ccc"/><button data-i="\${i}" data-t="a" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px">X</button></div>\`},hE(e){const t=e.target,i=t.dataset.i,type=t.dataset.t;if(!i||!type)return;t.tagName==='BUTTON'?this.rmR(type,i):(this[type][i][t.dataset.k]=t.value,this.rR())},addR(t){t==='c'?this.c.push({f:'',o:'c',v:''}):this.a.push({t:'s',f:'',v:''});this.rR()},rmR(t,i){this[t].splice(i,1);this.rR()},genF(){this.win.document.querySelectorAll(\`#\${this.pId} [data-i]\`).forEach(el=>{const{i,t,k}=el.dataset;this[t][i]&&(this[t][i][k]=el.value)});const vA=this.a.filter(a=>a.f);if(!vA.length)return alert('Please add at least one action.');const pN=prompt('Enter a name for your bookmarklet:','Custom Automation');if(!pN)return;const runL=this.bL();const b=\`javascript:(async()=>{const c={delay:300,uid:prompt("Enter your user sys_id if needed:")},findEnv=w=>{try{function findFS(n){let f=n.querySelector('#gsft_main,iframe[name="gsft_main"]');if(f)return f;const a=n.querySelectorAll('*');for(const e of a)if(e.shadowRoot&&(f=findFS(e.shadowRoot)))return f;return null}function getE(t){if(!t)return null;if(t.g_form&&typeof t.g_form.getTableName==='function')return{type:'form',ctx:{w:t,g:t.g_form}};const l=t.document.querySelector('#task_table,.list_table,[data-list_id]');if(l)return{type:'list',ctx:{w:t,l}};return null}const fe=findFS(w.document);if(fe&&fe.contentWindow){const fv=getE(fe.contentWindow);if(fv)return fv}return getE(w)}catch(e){}return null},runL=\${runL},sl=m=>new Promise(r=>setTimeout(r,m)),env=findEnv(window.top);if(!env)return alert('SN env not found.');if(env.type==='form'){const r=runL(env.ctx.g,c);if(r.changed&&confirm('Apply Change?'))return env.ctx.g.setValue(r.field,r.newVal),env.ctx.g.save(),void alert('Ticket updated!');return void alert('Conditions not met or no change needed.')}const{w:wC,l:lE}=env.ctx,tN=lE.getAttribute('glide_table')||'task',aT=[...wC.document.querySelectorAll('tr[sys_id]')].map(r=>r.getAttribute('sys_id')).filter(Boolean);if(!aT.length)return alert('No tickets in list.');const mI='sn-modal-'+Date.now(),mE=document.createElement('div');mE.id=mI,mE.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:#0008;z-index:99999;padding:10vh 5%;font-family:sans-serif;',mE.innerHTML=\\\`<div style="width:100%;max-width:800px;margin:auto;background:#fff;color:#000;border-radius:12px;display:flex;flex-direction:column"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Pre-flight Check</h3><div id="\${mI}-content" style="padding:20px;overflow-y:auto"></div><div id="\${mI}-footer" style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:space-between;align-items:center"></div></div>\\\`,document.body.appendChild(mE);const mo={content:document.getElementById(mI+'-content'),footer:document.getElementById(mI+'-footer'),close:()=>{document.getElementById(mI)&&mE.remove()}},cMF=(u,rj)=>{const fr=document.createElement('iframe');fr.style.cssText='position:absolute;left:-9999px;width:1px;height:1px;border:none;';const cl=()=>{clearTimeout(to),fr.onload=null,fr.onerror=null,fr.parentNode&&fr.parentNode.removeChild(fr)},to=setTimeout(()=>{cl(),rj(new Error('Timeout'))},8000);return document.body.appendChild(fr),fr.src=u,{frame:fr,cleanup:cl}},gTD=sI=>new Promise((rs,rj)=>{const u=\\\`\${tN}.do?sys_id=\${sI}&sysparm_nostack=true\\\`,{frame:fr,cleanup:cl}=cMF(u,rj);fr.onload=async()=>{try{const fE=await(w=>new Promise((r,e)=>{let a=0;(function t(){w&&w.g_form?r(w.g_form):a++<50?setTimeout(t,100):e(new Error('g_form NA'))})()}))(fr.contentWindow);rs({sysId:sI,...runL(fE,c)})}catch(e){rj(e)}finally{cl()}},fr.onerror=()=>{cl(),rj(new Error('Frame load error'))}}),pTP=async tI=>{const re=[];for(let i=0;i<tI.length;i+=5){const bt=tI.slice(i,i+5),br=await Promise.allSettled(bt.map(id=>gTD(id)));re.push(...br);mo.content.innerHTML='<p>Analyzing...('+re.length+'/'+tI.length+')</p>'}return re};async function shP(){mo.content.innerHTML='<p>Analyzing...(0/'+aT.length+')</p>';const aD=await pTP(aT);const sR=aD.filter(r=>r.status==='fulfilled').map(r=>r.value);rP(sR)}function rP(dt){let lH='<div style="max-height:50vh;overflow-y:auto;border:1px solid #8885;border-radius:6px;">';dt.forEach((t,i)=>{lH+=\\\`<div style="padding:8px;border-bottom:1px solid #8883;\${!t.changed?'opacity:0.5;':''}"><input type="checkbox" id="t\${i}" data-sysid="\${t.sysId}" \${!t.changed?'':'checked'} style="margin-right:12px;"><label for="t\${i}">\${t.originalTitle||'...'}</label>\${t.changed?\`<br><span style="color:green;">â†’ New Value: \${t.newVal}</span>\`:''}</div>\\\`}),lH+='</div>',mo.content.innerHTML=lH,mo.footer.innerHTML=\\\`<div><button id="\${mI}-all">All</button>|<button id="\${mI}-none">None</button></div><div><button id="\${mI}-cancel">Cancel</button><button id="\${mI}-proc" style="background:green;color:white;padding:8px 16px;border:none;border-radius:6px;">Process</button></div>\\\`,document.getElementById(mI+'-cancel').onclick=mo.close,document.getElementById(mI+'-proc').onclick=()=>stP(dt),document.getElementById(mI+'-all').onclick=()=>document.querySelectorAll('input[data-sysid]').forEach(c=>c.checked=!0),document.getElementById(mI+'-none').onclick=()=>document.querySelectorAll('input[data-sysid]').forEach(c=>c.checked=!1)}shP();async function stP(dt){const sT=dt.filter(d=>{const cb=document.querySelector(\\\`input[data-sysid="\${d.sysId}"]\\\`);return cb&&cb.checked});if(!sT.length)return mo.close();let ca=!1,pr={updated:0,errors:0};mo.content.innerHTML='<p>Processing...</p>',mo.footer.innerHTML=\\\`<button id="\${mI}-cancel-proc">Cancel</button>\\\`,document.getElementById(mI+'-cancel-proc').onclick=()=>ca=!0;const uT=(sI,f,v)=>new Promise((rs,rj)=>{const u=\\\`\${tN}.do?sys_id=\${sI}&sysparm_nostack=true\\\`,{frame:fr,cleanup:cl}=cMF(u,rj);fr.onload=async()=>{try{const fE=await(w=>new Promise((r,e)=>{let a=0;(function t(){w&&w.g_form?r(w.g_form):a++<50?setTimeout(t,100):e(new Error('g_form NA'))})()}))(fr.contentWindow);fE.setValue(f,v),fE.save(),setTimeout(()=>{cl(),rs()},1500)}catch(e){cl(),rj(e)}},fr.onerror=()=>{cl(),rj(new Error('Frame load error'))}});for(const t of sT){if(ca)break;try{await uT(t.sysId,t.field,t.newVal),pr.updated++}catch(e){pr.errors++}}mo.close(),alert(\\\`Complete: \${pr.updated} updated, \${pr.errors} errors.\\\`),pr.updated>0&&!ca&&wC.location.reload()}})()\\\`;const resEl=this.win.document.getElementById(this.pId+'-res');resEl.innerHTML=\`<h4>Bookmarklet Ready</h4><p>Drag this link to your bookmarks bar:</p><a href='\${b.replace(/'/g,"&apos;").replace(/"/g,"&quot;")}' style="display:inline-block;padding:10px 20px;background:#28a745;color:white;border-radius:5px;text-decoration:none;">\${pN}</a>\`;resEl.style.display='block'},bL(){let l='const pD=d=>{if(!d)return null;try{const D=new Date(d.replace(/-/g,"/"));return isNaN(D.getTime())?null:D}catch(e){return null}};';l+='let pass=!0;';this.c.forEach(c=>{const v=c.v.replace(/'/g,"\\\\'");switch(c.o){case'c':l+=\`if(!g.getValue('${c.f}').toLowerCase().includes('${v}'.toLowerCase()))pass=!1;\\\`;break;case'd':l+=\`if(g.getValue('${c.f}').toLowerCase().includes('${v}'.toLowerCase()))pass=!1;\\\`;break;case'i':l+=\`if(g.getValue('${c.f}')!='${v}')pass=!1;\\\`;break;case'n':l+=\`if(g.getValue('${c.f}')=='${v}')pass=!1;\\\`;break;case'e':l+=\`if(g.getValue('${c.f}'))pass=!1;\\\`;break;case'f':l+=\`{const dt=pD(g.getValue('${c.f}'));if(!dt||dt<=new Date())pass=!1;}\\\`;break}});let res={changed:!1,originalTitle:g.getValue('short_description')};l+='if(pass){';this.a.forEach(a=>{const v=a.v.replace(/'/g,"\\\\'");if(a.t==='s'){l+=\`res={changed:!0,field:'${a.f}',newVal:'${v}'};\\\`}else if(a.t==='p'){l+=\`const oT=g.getValue('${a.f}');res={changed:!0,field:'${a.f}',newVal:oT+'${v}'};\\\`}});l+='} return res;';return \`function(g,c){\${l}}\`},close(){this.win.document.removeEventListener('click',this.hB,true);this.win.document.getElementById(this.pId)?.remove()},bindEvts(){this.hB=this.hE.bind(this);this.win.document.getElementById(this.pId).addEventListener('change',this.hB);this.win.document.getElementById(this.pId).addEventListener('click',this.hB)}};builder.init();builder.bindEvts()})()`;
    
    // Create the result view
    const container = document.getElementById('step2');
    container.innerHTML = `
        <h2 class="text-2xl font-semibold mb-4 text-center text-slate-700">Your Builder is Ready</h2>
        <div class="bg-slate-100 p-6 rounded-lg text-center">
            <p class="font-medium text-slate-600">Drag this link to your bookmarks bar:</p>
            <div class="my-4 flex justify-center">
                <a href="${builderScript}" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">${name}</a>
            </div>
            <div class="mt-4 p-4 bg-green-50 border border-green-200 text-green-800 rounded-md text-left">
                <strong>How to Use:</strong>
                <ol class="list-decimal list-inside mt-2 text-sm">
                    <li>Drag the blue button above to your bookmarks bar.</li>
                    <li>Navigate to a ServiceNow form (like an Incident).</li>
                    <li>Click the bookmarklet to open the Rule Builder.</li>
                    <li>Define your conditions (IF) and actions (THEN).</li>
                    <li>Generate your final, custom automation bookmarklet from within the builder.</li>
                </ol>
            </div>
        </div>
        <div class="mt-6 text-center">
            <button id="startOverBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-600 hover:bg-slate-700">Back</button>
        </div>`;

    document.getElementById('startOverBtn').addEventListener('click', () => {
        document.getElementById('step1').classList.add('active');
        document.getElementById('step2').classList.remove('active');
    });

    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.add('active');

    showToast('Builder bookmarklet generated!');
});
</script>
</body>
</html>

