<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Automation - ServiceNow Bookmarklet Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="container w-full max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-800">Universal Automation Builder</h1>
                <p class="text-slate-600 mt-2">Generate a powerful on-page tool to build any automation you need.</p>
                <a href="ticket_template.html" class="text-blue-600 hover:underline mt-2 inline-block">&larr; Back to Tools</a>
            </header>

            <main id="app-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="step1">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-6">Generate Your Builder</h2>
                    <div class="p-4 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-sm">
                        Click the button below to generate a **Builder Bookmarklet**. Drag it to your bookmarks bar. When you're on a ServiceNow form, click the bookmarklet to open a powerful rule engine and create custom automation tools.
                    </div>
                    <div class="mt-6">
                        <label for="bookmarkletName" class="block text-sm font-medium text-slate-700">Builder Bookmarklet Name</label>
                        <input type="text" id="bookmarkletName" value="Automation Builder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="generateBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Generate Automation Builder</button>
                    </div>
                </div>

                <div id="step2" style="display:none;">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-slate-700">Your Builder is Ready</h2>
                    <div class="bg-slate-100 p-6 rounded-lg text-center">
                        <p class="font-medium text-slate-600">Drag this link to your bookmarks bar:</p>
                        <div class="my-4 flex justify-center">
                            <a id="bookmarklet-link" href="#" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"></a>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-green-50 border border-green-200 text-green-800 rounded-md text-left">
                        <strong>How to Use:</strong>
                        <ol class="list-decimal list-inside mt-2 text-sm">
                            <li>Drag the blue button above to your bookmarks bar.</li>
                            <li>Navigate to a ServiceNow form (e.g., an Incident) to scan its fields.</li>
                            <li>Click the bookmarklet to open the Rule Builder.</li>
                            <li>Define your conditions (IF) and actions (THEN).</li>
                            <li>Generate your final, custom automation bookmarklet from within the builder.</li>
                        </ol>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="startOverBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-600 hover:bg-slate-700">Back</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
document.getElementById('generateBtn').addEventListener('click', () => {
    const name = document.getElementById('bookmarkletName').value.trim() || 'Automation Builder';
    const builderScript = `javascript:(async()=>{const findEnv=w=>{try{function findFS(n){let f=n.querySelector('#gsft_main,iframe[name="gsft_main"]');if(f)return f;const a=n.querySelectorAll('*');for(const e of a)if(e.shadowRoot&&(f=findFS(e.shadowRoot)))return f;return null}function getE(t){if(!t)return null;if(t.g_form&&typeof t.g_form.getTableName==='function')return{type:'form',ctx:{w:t,g:t.g_form}};return null}const fe=findFS(w.document);if(fe&&fe.contentWindow){const fv=getE(fe.contentWindow);if(fv)return fv}return getE(w)}catch(e){}return null};const env=findEnv(window.top);if(!env||env.type!=='form')return alert('Please run the Automation Builder on a ServiceNow form page.');const b={w:env.ctx.w,g:env.ctx.g,pId:'auto-b-'+Date.now(),f:[],c:[],a:[],init(){if(this.w.document.getElementById(this.pId))return;this.sF();this.bUI()},sF(){const m=new Map();this.f=this.g.elements.map(e=>{const n=e.fieldName;const field=this.g.getField(n);if(m.has(n)||!field?.visible)return null;m.set(n,!0);return{n,l:this.g.getLabelOf(n)||n,type:field.type}}).filter(Boolean).sort((x,y)=>x.l.localeCompare(y.l))},bUI(){const h=\`<div id="\${this.pId}" style="position:fixed;top:5%;left:50%;transform:translateX(-50%);width:90%;max-width:800px;background:#fff;color:#000;border-radius:12px;box-shadow:0 8px 32px #0005;z-index:999999;font-family:sans-serif;display:flex;flex-direction:column;max-height:90vh"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Automation Builder</h3><div style="padding:20px;overflow-y:auto;flex-grow:1"><div style="margin-bottom:20px"><h4 style="margin:0 0 10px;font-size:1.1em;">Conditions (IF)</h4><div id="\${this.pId}-c"></div><div style="margin-top:10px;font-size:0.9em;display:flex;gap:15px;align-items:center"><button id="\${this.pId}-add-c" style="padding:6px 12px;background:#eef;border:1px solid #ccf;color:#339;border-radius:4px;cursor:pointer">+ Add</button><div><label><input type="radio" name="\${this.pId}-mode" value="f" checked> Filter list</label><label style="margin-left:10px"><input type="radio" name="\${this.pId}-mode" value="h"> Highlight matches</label></div></div></div><div><h4 style="margin:0 0 10px;font-size:1.1em;">Actions (THEN)</h4><div id="\${this.pId}-a"></div><button id="\${this.pId}-add-a" style="margin-top:10px;padding:6px 12px;background:#efe;border:1px solid #cfc;color:#393;border-radius:4px;cursor:pointer">+ Add</button></div></div><div id="\${this.pId}-res" style="display:none;padding:0 20px 20px;"></div><div style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:flex-end;gap:10px"><button id="\${this.pId}-close">Close</button><button id="\${this.pId}-gen" style="background:#0066cc;color:white;padding:8px 16px;border:none;border-radius:6px">Generate</button></div></div>\`;this.w.document.body.insertAdjacentHTML('beforeend',h);this.w.document.getElementById(this.pId+'-add-c').onclick=()=>this.addR('c');this.w.document.getElementById(this.pId+'-add-a').onclick=()=>this.addR('a');this.w.document.getElementById(this.pId+'-close').onclick=()=>this.close();this.w.document.getElementById(this.pId+'-gen').onclick=()=>this.genF();this.rR()},rR(){const cC=this.w.document.getElementById(this.pId+'-c'),aC=this.w.document.getElementById(this.pId+'-a'),fO=this.f.map(f=>\`<option value="\${f.n}">\${f.l}</option>\`).join('');cC.innerHTML=this.c.length?this.c.map((c,i)=>this.rC(c,i,fO)).join(''):'<p style="text-align:center;color:#666;font-size:.9em;padding:10px">No conditions. Actions will run on all tickets.</p>';aC.innerHTML=this.a.length?this.a.map((a,i)=>this.rA(a,i,fO)).join(''):'<p style="text-align:center;color:#666;font-size:.9em;padding:10px">No actions.</p>'},rC(c,i,fO){const selF=this.f.find(f=>f.n===c.f);const isDate=selF?.type==='glide_date'||selF?.type==='glide_date_time';return \`<div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #f0f0f0"><select data-i="\${i}" data-t="c" data-k="f" style="flex:2;padding:6px;border:1px solid #ccc"><option value="">Select Field</option>\${fO.replace('value="'+c.f+'"','value="'+c.f+'" selected')}</select><select data-i="\${i}" data-t="c" data-k="o" style="flex:1;padding:6px;border:1px solid #ccc"><option value="c" \${c.o==='c'?'selected':''}>contains</option><option value="d" \${c.o==='d'?'selected':''}>not contain</option><option value="i" \${c.o==='i'?'selected':''}>is</option><option value="n" \${c.o==='n'?'selected':''}>is not</option><option value="e" \${c.o==='e'?'selected':''}>is empty</option><option value="f" \${c.o==='f'?'selected':''} \${!isDate?'disabled':''}>is in future</option></select><input type="text" value="\${c.v||''}" data-i="\${i}" data-t="c" data-k="v" placeholder="Value" style="flex:2;padding:6px;border:1px solid #ccc;\${['e','f'].includes(c.o)?'visibility:hidden;':''}"/><button data-i="\${i}" data-t="c" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px">X</button></div>\`},rA(a,i,fO){return \`<div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #f0f0f0"><select data-i="\${i}" data-t="a" data-k="f" style="flex:2;padding:6px;border:1px solid #ccc"><option value="">Select Field</option>\${fO.replace('value="'+a.f+'"','value="'+a.f+'" selected')}</select><span>=</span><input type="text" value="\${a.v||''}" data-i="\${i}" data-t="a" data-k="v" placeholder="Value" style="flex:2;padding:6px;border:1px solid #ccc"\${a.p?'disabled':''}><label style="font-size:.9em;display:flex;align-items:center"><input type="checkbox" data-i="\${i}" data-t="a" data-k="p" \${a.p?'checked':''}>Prompt?</label><button data-i="\${i}" data-t="a" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px">X</button></div>\`},hE(e){const t=e.target,i=t.dataset.i,type=t.dataset.t;if(!i||!type)return;if(t.tagName==='BUTTON')return this.rmR(type,i);const k=t.dataset.k,val=t.type==='checkbox'?t.checked:t.value;this[type][i][k]=val;this.rR()},addR(t){t==='c'?this.c.push({f:'',o:'c',v:''}):this.a.push({f:'',v:'',p:!1});this.rR()},rmR(t,i){this[t].splice(i,1);this.rR()},genF(){this.win.document.querySelectorAll(\`#\${this.pId} [data-i]\`).forEach(el=>{const{i,t,k}=el.dataset,val=el.type==='checkbox'?el.checked:el.value;this[t][i]&&(this[t][i][k]=val)});const vA=this.a.filter(a=>a.f);if(!vA.length)return alert('Add at least one action.');const pN=prompt('Bookmarklet Name:','Custom Tool');if(!pN)return;const mode=this.win.document.querySelector(\`input[name="\${this.pId}-mode"]:checked\`).value;const pA=vA.filter(a=>a.p),sA=vA.filter(a=>!a.p);const runL=this.bL(this.c);const b=\`javascript:(async()=>{const c={sA:\${JSON.stringify(sA)},pA:\${JSON.stringify(pA)},mode:'\${mode}'},findEnv=w=>{try{function findFS(n){let f=n.querySelector('#gsft_main,iframe[name="gsft_main"]');if(f)return f;for(const e of n.querySelectorAll('*'))if(e.shadowRoot&&(f=findFS(e.shadowRoot)))return f;return null}function getE(t){if(!t)return null;const l=t.document.querySelector('#task_table,.list_table,[data-list_id]');return l?{type:'list',ctx:{w:t,l}}:null}const fe=findFS(w.document);if(fe&&fe.contentWindow){const fv=getE(fe.contentWindow);if(fv)return fv}return getE(w)}catch(e){}return null},runL=\${runL},env=findEnv(window.top);if(!env||env.type!=='list')return alert('Run on a list view.');const{w:wC,l:lE}=env.ctx,tN=lE.getAttribute('glide_table')||'task',aT=[...wC.document.querySelectorAll('tr[sys_id]')].map(r=>r.getAttribute('sys_id')).filter(Boolean);if(!aT.length)return alert('No tickets in list.');const mI='sn-m-'+Date.now(),mE=document.createElement('div');mE.id=mI;mE.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:#0008;z-index:99999;font-family:sans-serif;padding:5vh 5%';mE.innerHTML=\\\`<div style="width:100%;max-width:800px;margin:auto;background:#fff;color:#000;border-radius:12px;display:flex;flex-direction:column;max-height:90vh"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Run Automation</h3><div id="\${mI}-content" style="padding:20px;overflow-y:auto"></div><div id="\${mI}-footer" style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:flex-end;gap:10px"></div></div>\\\`;document.body.appendChild(mE);const mo={c:document.getElementById(mI+'-content'),f:document.getElementById(mI+'-footer'),rm:()=>mE.remove()},cMF=u=>{return new Promise((rs,rj)=>{const fr=document.createElement('iframe');fr.style.cssText='position:absolute;left:-9999px';const cl=()=>{clearTimeout(to),fr.remove()},to=setTimeout(()=>rj(new Error('Timeout')),8e3);fr.onload=()=>{clearTimeout(to);rs({fr,cl})};fr.onerror=()=>rj(new Error('Frame error'));document.body.appendChild(fr);fr.src=u})},gTD=async sI=>{try{const{fr,cl}=await cMF(\\\`/\${tN}.do?sys_id=\${sI}&sysparm_nostack=true\\\`);try{const g=await(w=>new Promise((r,e)=>{let a=0;(function t(){w&&w.g_form?r(w.g_form):a++<50?setTimeout(t,100):e(new Error('g_form NA'))})()}))(fr.contentWindow);return{sysId:sI,isMatch:runL(g),g}}catch(e){console.warn('Skipping ticket \${sI}:',e);return null}finally{cl&&cl()}}};async function shP(){mo.c.innerHTML='<p>Analyzing...</p>';const results=await Promise.all(aT.map(gTD));const dt=results.filter(r=>r&&(c.mode==='h'||r.isMatch));let lH='<div style="margin-bottom:15px;display:flex;flex-direction:column;gap:10px;">';c.pA.forEach((a,i)=>{lH+=\\\`<div><label style="display:block;font-weight:500;margin-bottom:5px;">\${a.f}:</label><textarea id="prompt-\${i}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;min-height:60px"></textarea></div>\\\`});lH+='</div><div style="max-height:40vh;overflow-y:auto;border:1px solid #ccc;border-radius:6px">';dt.forEach((t,i)=>{const oV=t.g.getValue('short_description')||'(no title)';lH+=\\\`<div style="padding:8px;border-bottom:1px solid #eee;\${c.mode==='h'&&t.isMatch?'background:#fff3cd;':''}"><input type="checkbox" id="t\${i}" data-sysid="\${t.sysId}" \${c.mode==='h'&&t.isMatch?'checked':(c.mode==='f'?'checked':'')} style="margin-right:8px"><label for="t\${i}">\${oV}</label></div>\\\`});lH+='</div>';mo.c.innerHTML=lH;mo.f.innerHTML=\\\`<div>\${c.mode==='h'?'<button id="\${mI}-match">Select Matches</button>':''}<button id="\${mI}-all">All</button>|<button id="\${mI}-none">None</button></div><div><button id="\${mI}-cancel">Cancel</button><button id="\${mI}-proc" style="background:green;color:white;padding:8px 16px;border:none;border-radius:6px">Process</button></div>\\\`;document.getElementById(mI+'-cancel').onclick=mo.rm;document.getElementById(mI+'-proc').onclick=()=>stP(dt);document.getElementById(mI+'-all').onclick=()=>document.querySelectorAll('input[data-sysid]').forEach(c=>c.checked=!0);document.getElementById(mI+'-none').onclick=()=>document.querySelectorAll('input[data-sysid]').forEach(c=>c.checked=!1);if(c.mode==='h')document.getElementById(mI+'-match').onclick=()=>dt.forEach(t=>{const cb=document.querySelector(\\\`input[data-sysid="\${t.sysId}"]\\\`);if(cb)cb.checked=t.isMatch})}shP();async function stP(dt){const sT=dt.filter(d=>{const cb=document.querySelector(\\\`input[data-sysid="\${d.sysId}"]\\\`);return cb&&cb.checked});if(!sT.length)return mo.rm();const pV={};c.pA.forEach((a,i)=>{pV[a.f]=document.getElementById('prompt-'+i).value});let pr={u:0,e:0};mo.c.innerHTML='<p>Processing...</p>',mo.f.innerHTML='';const uT=async t=>{try{const{fr,cl}=await cMF(\\\`/\${tN}.do?sys_id=\${t.sysId}&sysparm_nostack=true\\\`);try{const g=await(w=>new Promise((r,e)=>{let a=0;(function t(){w&&w.g_form?r(w.g_form):a++<50?setTimeout(t,100):e(new Error('g_form NA'))})()}))(fr.contentWindow);c.sA.forEach(a=>g.setValue(a.f,a.v));c.pA.forEach(a=>{const v=pV[a.f];if(v)g.setValue(a.f,v)});g.save();await new Promise(r=>setTimeout(r,1500))}finally{cl&&cl()}}catch(e){throw e}};for(const t of sT){try{await uT(t),pr.u++}catch(e){pr.e++}mo.c.innerHTML=\\\`<p>Processing...(\${pr.u+pr.e}/\${sT.length})</p>\\\`}mo.rm();alert(\\\`Complete: \${pr.u} updated, \${pr.e} errors.\\\`);pr.u>0&&wC.location.reload()}})()\\\`;const resEl=this.w.document.getElementById(this.pId+'-res');resEl.innerHTML=\`<h4>Bookmarklet Ready</h4><p>Drag this link to your bookmarks bar:</p><a href='\${b.replace(/'/g,"&apos;").replace(/"/g,"&quot;")}' style="display:inline-block;padding:10px 20px;background:#28a745;color:white;text-decoration:none;">\${pN}</a>\`;resEl.style.display='block'},bL(c){let l='let p=!0;try{';c.forEach(c=>{const v=c.v.replace(/'/g,"\\\\'");switch(c.o){case'c':l+=\`if(!g.getValue('\${c.f}').toLowerCase().includes('\${v}'.toLowerCase()))p=!1;\\\`;break;case'd':l+=\`if(g.getValue('\${c.f}').toLowerCase().includes('\${v}'.toLowerCase()))p=!1;\\\`;break;case'i':l+=\`if(g.getValue('\${c.f}')!='\${v}')p=!1;\\\`;break;case'n':l+=\`if(g.getValue('\${c.f}')=='\${v}')p=!1;\\\`;break;case'e':l+=\`if(g.getValue('\${c.f}'))p=!1;\\\`;break;case'f':l+='{const dt=new Date(g.getValue(\\'${c.f}\\\').replace(/-/g,"/"));if(!dt||dt<=new Date())p=!1;}';break;}});l+='}catch(e){p=!1;console.warn("Condition check failed, skipping:",e.message)}return p;';return \`function(g){\${l}}\`},close(){this.w.document.removeEventListener('click',this.cB,true);this.w.document.getElementById(this.pId)?.remove()},bindEvts(){this.cB=this.cH.bind(this);this.w.document.addEventListener('click',this.cB,!0);this.hB=this.hE.bind(this);this.w.document.getElementById(this.pId).addEventListener('change',this.hB);this.w.document.getElementById(this.pId).addEventListener('click',this.hB)}};b.init();b.bindEvts()})()`;
    
    const link = document.getElementById('bookmarklet-link');
    link.href = builderScript;
    link.textContent = name;
    
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
});

document.getElementById('startOverBtn').addEventListener('click', () => {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
});
</script>
</body>
</html>


