<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Extractor - ServiceNow Bookmarklet Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); color: white; opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body class="bg-slate-100">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="container w-full max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-800">Data Extractor Builder</h1>
                <p class="text-slate-600 mt-2">Build CSV extractors for ServiceNow list views.</p>
                <a href="ticket_template.html" class="text-blue-600 hover:underline mt-2 inline-block">&larr; Back to Tools</a>
            </header>

            <main id="app-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="step1" class="step active">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-6">Configure Builder</h2>
                    <div class="space-y-6">
                        <div class="p-4 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-sm">
                            This creates a builder tool. Run it on a ServiceNow form to select fields for extraction, then generate your final CSV extractor bookmarklet.
                        </div>
                        <div>
                            <label for="bookmarkletName" class="block text-sm font-medium text-slate-700">Bookmarklet Name</label>
                            <input type="text" id="bookmarkletName" value="Data Extractor" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="generateBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Generate Builder</button>
                    </div>
                </div>

                <div id="step2" class="step">
                     <h2 class="text-2xl font-semibold text-slate-800 mb-4">Builder Bookmarklet Ready</h2>
                     <p class="text-slate-600 mb-4">Drag the link below to your bookmarks bar. Then, navigate to a ServiceNow form (like an Incident or Request) and click the bookmarklet to start building your extractor.</p>
                     <div id="bookmarkletContainer" class="p-4 bg-slate-100 border border-slate-200 rounded-lg text-center">
                         </div>
                     <div class="mt-8 flex justify-end">
                        <button id="startOverBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-600 hover:bg-slate-700">Start Over</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="toast-container"></div>

<script>
const SN_UI_MODULE = `const SN_UI={_createModal(id,contentHtml){const existing=document.getElementById(id);if(existing)existing.remove();const modalEl=document.createElement('div');modalEl.id=id;modalEl.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999999;display:flex;align-items:center;justify-content:center;font-family:sans-serif;';modalEl.innerHTML='<div style="width:90%;max-width:450px;background:#fff;color:#000;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);display:flex;flex-direction:column;">'+contentHtml+'</div>';document.body.appendChild(modalEl);return modalEl},showInfo(title,message){return new Promise((resolve)=>{const id='sn-modal-'+Date.now();const content='<h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0;font-size:1.1em;">'+title+'</h3><div style="padding:20px;line-height:1.5;">'+message+'</div><div style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:flex-end;gap:10px;"><button id="'+id+'-ok-btn" style="padding:8px 16px;border:none;border-radius:6px;background:#0066cc;color:white;cursor:pointer;">OK</button></div>';const modal=this._createModal(id,content);document.getElementById(id+'-ok-btn').onclick=()=>{modal.remove();resolve()}})},prompt(title,message,defaultValue=''){return new Promise((resolve)=>{const id='sn-modal-'+Date.now();const content='<h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0;font-size:1.1em;">'+title+'</h3><div style="padding:20px;"><p style="margin:0 0 10px;">'+message+'</p><input type="text" id="'+id+'-input" value="'+defaultValue+'" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;"></div><div style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:flex-end;gap:10px;"><button id="'+id+'-cancel-btn" style="padding:8px 16px;border:1px solid #ccc;border-radius:6px;background:#eee;color:black;cursor:pointer;">Cancel</button><button id="'+id+'-ok-btn" style="padding:8px 16px;border:none;border-radius:6px;background:#0066cc;color:white;cursor:pointer;">OK</button></div>';const modal=this._createModal(id,content);const inputEl=document.getElementById(id+'-input');inputEl.focus();inputEl.select();const okAction=()=>{modal.remove();resolve(inputEl.value)};const cancelAction=()=>{modal.remove();resolve(null)};document.getElementById(id+'-ok-btn').onclick=okAction;document.getElementById(id+'-cancel-btn').onclick=cancelAction;inputEl.addEventListener('keydown',(e)=>{if(e.key==='Enter')okAction();if(e.key==='Escape')cancelAction()})})}`;

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function switchStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${step}`).classList.add('active');
}

const app = {
    init() {
        document.getElementById('generateBtn').addEventListener('click', () => this.generate());
        document.getElementById('startOverBtn').addEventListener('click', () => switchStep(1));
    },
    generate() {
        const name = document.getElementById('bookmarkletName').value.trim() || 'Data Extractor';
        
        const findEnv = `function(w){try{function e(t){let n=t.querySelector("#gsft_main,iframe[name=gsft_main]");if(n)return n;const o=t.querySelectorAll("*");for(const r of o)if(r.shadowRoot&&(n=e(r.shadowRoot)))return n;return null}function t(n){return n?n.g_form&&"function"==typeof n.g_form.getTableName?{type:"form",context:{win:n,g_form:n.g_form}}:n.document.querySelector("#task_table,.list_table,[data-list_id]")?{type:"list",context:{win:n,listEl:n.document.querySelector("#task_table,.list_table,[data-list_id]")}}:null:null}const n=e(w.document);if(n&&n.contentWindow){try{const o=t(n.contentWindow);if(o)return o}catch(o){}}return t(w)}catch(o){return null}}`;
        const waitForGForm = `(w)=>new Promise((r,e)=>{let t=0;const n=()=>{w&&w.g_form&&"function"==typeof w.g_form.getValue?r(w.g_form):t++<50?setTimeout(n,100):e(new Error("g_form not available"))};n()})`;
        
        const builderCode = `javascript:(async function(){${SN_UI_MODULE}const findEnv=${findEnv};const waitForGForm=${waitForGForm};const b={fields:[],filters:[],panelId:'sde-'+Date.now(),async init(){const e=findEnv(window.top);if(!e||e.type!=='form'){await SN_UI.showInfo('Error','Please run this on a ServiceNow form view (e.g., an Incident or Request).');return}if(e.context.win.document.getElementById(this.panelId))return;this.g_form=e.context.g_form;this.win=e.context.win;this.scanFields();this.buildUI();this.win.document.addEventListener('click',this.clickHandler.bind(this),true)},scanFields(){if(!this.g_form.elements)return;const m=new Map();this.availableFields=this.g_form.elements.map(e=>{const n=e.fieldName;if(m.has(n))return null;const f=this.g_form.getField(n);if(!f)return null;m.set(n,true);return{name:n,label:this.g_form.getLabelOf(n),type:f.type}}).filter(f=>f&&f.name&&f.label)},buildUI(){const h='<div id="'+this.panelId+'" style="position:fixed;top:5%;left:50%;transform:translateX(-50%);width:90%;max-width:800px;background:#fff;color:#000;border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:999999;font-family:sans-serif;display:flex;flex-direction:column;max-height:85vh;"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:8px 8px 0 0">Data Extractor Builder</h3><div style="padding:20px;overflow-y:auto;flex-grow:1;"><div style="margin-bottom:20px;"><h4 style="margin:0 0 10px;font-size:1.1em;">Fields to Extract</h4><p style="margin:0 0 10px;font-size:0.85em;color:#666;">Click on form field labels to add them to the extraction list below.</p><div id="'+this.panelId+'-fields" style="border:1px solid #ccc;border-radius:6px;min-height:60px;max-height:200px;overflow-y:auto;padding:10px;"></div></div><div><h4 style="margin:0 0 10px;font-size:1.1em;">Filters (Optional)</h4><p style="margin:0 0 10px;font-size:0.85em;color:#666;">Add conditions to filter which records get extracted from the list view.</p><div id="'+this.panelId+'-filters" style="border:1px solid #ccc;border-radius:6px;min-height:60px;max-height:200px;overflow-y:auto;padding:10px;"></div><button id="'+this.panelId+'-addfilter" style="margin-top:10px;padding:6px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;">Add Filter</button></div></div><div style="padding:20px;border-top:1px solid #ccc;display:flex;gap:10px;justify-content:center;"><button id="'+this.panelId+'-gen" style="padding:8px 16px;background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer;">Generate Extractor</button><button id="'+this.panelId+'-close" style="padding:8px 16px;background:#6c757d;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button></div><div id="'+this.panelId+'-result" style="display:none;padding:0 20px 20px;"></div></div>';this.win.document.body.insertAdjacentHTML('beforeend',h);this.win.document.getElementById(this.panelId+'-addfilter').onclick=()=>this.addFilter();this.win.document.getElementById(this.panelId+'-gen').onclick=()=>this.generateFinal();this.win.document.getElementById(this.panelId+'-close').onclick=()=>this.close();this.win.extractorBuilder=this;this.updateUI()},updateUI(){const fc=this.win.document.getElementById(this.panelId+'-fields');const fic=this.win.document.getElementById(this.panelId+'-filters');if(fc)fc.innerHTML=this.fields.length?this.fields.map((f,i)=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #eee;"><div><strong>'+f.label+'</strong><br><span style="font-size:0.85em;opacity:0.7;">('+f.name+')</span></div><button onclick="window.extractorBuilder.removeField('+i+')" style="padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;">&times;</button></div>').join(''):'<div style="padding:20px;text-align:center;color:#6c757d;">Click form fields to add</div>';const fieldOpts=this.availableFields.map(f=>'<option value="'+f.name+'">'+f.label+'</option>').join('');if(fic)fic.innerHTML=this.filters.length?this.filters.map((f,i)=>'<div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #eee;font-size:0.9em;"><select onchange="window.extractorBuilder.updateFilter('+i+',\\'field\\',this.value)" style="flex:1;padding:4px;border:1px solid #ccc;border-radius:4px;"><option value="">Select Field</option>'+fieldOpts.replace('value="'+f.field+'"','value="'+f.field+'" selected')+'</select><select onchange="window.extractorBuilder.updateFilter('+i+',\\'operator\\',this.value)" style="padding:4px;border:1px solid #ccc;border-radius:4px;"><option value="contains" '+(f.operator==='contains'?'selected':'')+'>contains</option><option value="equals" '+(f.operator==='equals'?'selected':'')+'>equals</option><option value="not_contains" '+(f.operator==='not_contains'?'selected':'')+'>not contains</option><option value="starts_with" '+(f.operator==='starts_with'?'selected':'')+'>starts with</option></select><input type="text" placeholder="value" value="'+(f.value||'')+'" onchange="window.extractorBuilder.updateFilter('+i+',\\'value\\',this.value)" style="flex:1;padding:4px;border:1px solid #ccc;border-radius:4px;"><button onclick="window.extractorBuilder.removeFilter('+i+')" style="padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;">&times;</button></div>').join(''):'<div style="padding:20px;text-align:center;color:#6c757d;">No filters. All records will be extracted.</div>'},clickHandler(e){try{if(e.target.closest('#'+this.panelId))return;const el=e.target.closest('div.form-group,tr[data-form-type]');if(!el)return;e.preventDefault();e.stopPropagation();let input=el.querySelector('select, input:not([type=\\"hidden\\"]), textarea')||e.target.closest('select, input:not([type=\\"hidden\\"]), textarea');if(!input){const refField=el.querySelector('[data-ref-id], [data-reference]');if(refField)input=refField}if(!input)return;const originalName=input.getAttribute('data-sn-name')||input.name||input.id;const cleanName=originalName.replace(/^sys_display\\./,'').replace(/^[a-z_]+\\./,'');if(!cleanName||!this.g_form.hasField(cleanName)||this.fields.find(f=>f.name===cleanName))return;this.fields.push({name:cleanName,label:this.g_form.getLabelOf(cleanName)||cleanName});this.updateUI()}catch(error){console.warn('Field capture failed:',error.message)}},removeField(i){this.fields.splice(i,1);this.updateUI()},addFilter(){this.filters.push({field:'',operator:'contains',value:''});this.updateUI()},removeFilter(i){this.filters.splice(i,1);this.updateUI()},updateFilter(i,k,v){this.filters[i][k]=v},close(){this.win.document.removeEventListener('click',this.clickHandler,true);this.win.document.getElementById(this.panelId).remove();delete this.win.extractorBuilder;},async generateFinal(){if(!this.fields.length){await SN_UI.showInfo('Info','Please add at least one field to extract.');return}const n=await SN_UI.prompt('Final Bookmarklet Name','Enter a name for your extractor bookmarklet:','CSV Export');if(!n)return;const cfg={fields:this.fields,filters:this.filters.filter(f=>f.field&&f.value)};const code=\`javascript:(async function(){${SN_UI_MODULE}const findEnv=${findEnv};const waitForGForm=${waitForGForm};const cfg=${JSON.stringify(cfg)};(async()=>{try{const env=findEnv(window.top);if(!env||env.type!=='list')throw new Error('Please run this on a ServiceNow list view.');const {win:winCtx,listEl}=env.context;const tableName=listEl.getAttribute('glide_table')||'task';const allRows=Array.from(listEl.querySelectorAll('tbody > tr')).map(row=>({sysId:row.getAttribute('sys_id'),row:row})).filter(r=>r.sysId);if(!allRows.length)throw new Error('No records found on the current page.');const modalId='extract-modal-'+Date.now();document.body.insertAdjacentHTML('beforeend','<div id="'+modalId+'" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#0008;z-index:99999;display:flex;align-items:center;justify-content:center;font-family:sans-serif;"><div style="width:90%;max-width:600px;background:#fff;color:#000;border-radius:12px;"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Extracting Data</h3><div id="'+modalId+'-content" style="padding:20px;">Processing...</div></div></div>');const modal={content:document.getElementById(modalId+'-content')};const createFrame=(url)=>new Promise((resolve,reject)=>{const fr=document.createElement('iframe');fr.style.cssText='position:absolute;left:-9999px;width:1px;height:1px;';const clean=()=>{clearTimeout(t);fr.onload=fr.onerror=null;fr.remove()};const t=setTimeout(()=>{clean();reject(new Error('Frame load timeout'))},8000);fr.onload=()=>{clearTimeout(t);resolve({frame:fr,cleanup:clean})};fr.onerror=()=>{clean();reject(new Error('Frame load error'))};document.body.appendChild(fr);fr.src=url});const extractFromTicket=async(sysId)=>{const {frame,cleanup}=await createFrame('/'+tableName+'.do?sys_id='+sysId+'&sysparm_nostack=true');try{const g_form=await waitForGForm(frame.contentWindow);const data={};cfg.fields.forEach(f=>{data[f.name]=g_form.getValue(f.name)||''});if(cfg.filters.length>0){let passesFilter=true;for(const filter of cfg.filters){const fVal=String(g_form.getValue(filter.field)).toLowerCase();const testVal=filter.value.toLowerCase();switch(filter.operator){case'contains':if(!fVal.includes(testVal))passesFilter=false;break;case'equals':if(fVal!==testVal)passesFilter=false;break;case'not_contains':if(fVal.includes(testVal))passesFilter=false;break;case'starts_with':if(!fVal.startsWith(testVal))passesFilter=false;break}if(!passesFilter)break}if(!passesFilter)return null}return data}finally{cleanup()}};const allData=[];let processed=0;for(const ticket of allRows){try{const data=await extractFromTicket(ticket.sysId);if(data)allData.push(data);processed++;modal.content.textContent='Processing... ('+processed+'/'+allRows.length+')'}catch(e){console.error('Failed to extract ticket '+ticket.sysId+':',e);processed++}}if(!allData.length){modal.content.innerHTML='<p>No records matched the specified filters.</p><button onclick="document.getElementById(\\'\\\\''+modalId+'\\\\\\').remove()" style="margin-top:10px;padding:8px 16px;background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button>';return}const escapeCSV=(val)=>{const str=String(val==null?'':val);if(/[",\\\\n\\\\r]/.test(str)){return'"'+str.replace(/\\"/g,'""')+'"'}return str};const headers=cfg.fields.map(f=>f.label);const csvRows=[headers.map(escapeCSV).join(',')];allData.forEach(row=>{const values=cfg.fields.map(f=>row[f.name]);csvRows.push(values.map(escapeCSV).join(','))});const csvContent=csvRows.join('\\n');const blob=new Blob([String.fromCharCode(0xFEFF),csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');const url=URL.createObjectURL(blob);const safeName='${n}'.replace(/[^a-zA-Z0-9._-]+/g,'_')||'export';link.setAttribute('href',url);link.setAttribute('download',safeName+'.csv');link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);modal.content.innerHTML='<p style="text-align:center;color:#22c55e;font-weight:bold;">Extraction Complete!</p><p>'+allData.length+' record(s) exported.</p><button onclick="document.getElementById(\\'\\\\''+modalId+'\\\\\\').remove()" style="margin-top:10px;padding:8px 16px;background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button>';}catch(e){console.error('Extractor Error:',e);SN_UI.showInfo('Error',e.message||'An unknown error occurred.')}})()})()\`;const resultDiv=this.win.document.getElementById(this.panelId+'-result');resultDiv.innerHTML='<h4 style="margin:10px 0;font-size:1.1em;text-align:left;">Your Extractor is Ready!</h4><p style="margin:0 0 10px;font-size:0.85em;color:#666;text-align:left;">Drag this link to your bookmarks bar:</p><div style="text-align:center;padding:15px;background:#eef2ff;border-radius:6px;border:1px solid #c7d2fe;"><a href="'+code.replace(/"/g,'&quot;')+'" style="font-size:1.1em;font-weight:bold;color:#3730a3;text-decoration:none;">'+n+'</a></div><p style="margin:10px 0 0;font-size:0.8em;color:#666;text-align:left;">Then, go to a ServiceNow list view and click the bookmarklet to run it.</p>';resultDiv.style.display='block';this.win.document.getElementById(this.panelId+'-gen').style.display='none';}};b.init()})()`;
        
        const bookmarkletLink = document.createElement('a');
        bookmarkletLink.href = builderCode;
        bookmarkletLink.textContent = name;
        bookmarkletLink.className = "inline-block px-5 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-move";
        
        const container = document.getElementById('bookmarkletContainer');
        container.innerHTML = '';
        container.appendChild(bookmarkletLink);
        
        switchStep(2);
        showToast('Builder bookmarklet generated!');
    }
};

app.init();
</script>
</body>
</html>
