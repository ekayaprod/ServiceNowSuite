<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Extractor - ServiceNow Bookmarklet Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="container w-full max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-800">Data Extractor</h1>
                <p class="text-slate-600 mt-2">Generate a builder to create custom CSV extractors.</p>
                <a href="ticket_template.html" class="text-blue-600 hover:underline mt-2 inline-block">&larr; Back to Tools</a>
            </header>

            <main id="app-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="step1">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-6">Generate Your Builder</h2>
                    <div class="p-4 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-sm">
                        Click the button below to generate an **Extractor Builder** bookmarklet. Run it on a ServiceNow form to select fields and create your final, custom extractor tool.
                    </div>
                    <div class="mt-6">
                        <label for="bookmarkletName" class="block text-sm font-medium text-slate-700">Builder Bookmarklet Name</label>
                        <input type="text" id="bookmarkletName" value="Extractor Builder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="generateBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Generate Extractor Builder</button>
                    </div>
                </div>

                <div id="step2" style="display:none;">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-slate-700">Your Builder is Ready</h2>
                    <div class="bg-slate-100 p-6 rounded-lg text-center">
                        <p class="font-medium text-slate-600">Drag this link to your bookmarks bar:</p>
                        <div class="my-4 flex justify-center">
                            <a id="bookmarklet-link" href="#" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"></a>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-green-50 border border-green-200 text-green-800 rounded-md text-left">
                        <strong>How to Use:</strong>
                        <ol class="list-decimal list-inside mt-2 text-sm">
                            <li>Drag the blue button above to your bookmarks bar.</li>
                            <li>Navigate to a ServiceNow **form** (e.g., an Incident) to scan its fields.</li>
                            <li>Click the bookmarklet to open the builder.</li>
                            <li>Click field labels on the form to add them to your export.</li>
                            <li>Generate your final extractor tool from within the builder.</li>
                        </ol>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="startOverBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-600 hover:bg-slate-700">Back</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
document.getElementById('generateBtn').addEventListener('click', () => {
    const name = document.getElementById('bookmarkletName').value.trim() || 'Extractor Builder';

    const builderScript = `javascript:(async()=>{const findEnv=w=>{try{function findFS(n){let f=n.querySelector('#gsft_main,iframe[name="gsft_main"]');if(f)return f;const a=n.querySelectorAll('*');for(const e of a)if(e.shadowRoot&&(f=findFS(e.shadowRoot)))return f;return null}function getE(t){if(!t)return null;if(t.g_form&&typeof t.g_form.getTableName==='function')return{type:'form',ctx:{w:t,g:t.g_form}};return null}const fe=findFS(w.document);if(fe&&fe.contentWindow){const fv=getE(fe.contentWindow);if(fv)return fv}return getE(w)}catch(e){}return null};const env=findEnv(window.top);if(!env||env.type!=='form')return alert('Please run the Builder on a ServiceNow form page.');const b={w:env.ctx.w,g:env.ctx.g,pId:'ext-b-'+Date.now(),f:[],c:[],e:[],init(){if(this.w.document.getElementById(this.pId))return;this.sF();this.bUI()},sF(){const m=new Map();this.f=this.g.elements.map(e=>{const n=e.fieldName;if(m.has(n)||!this.g.getField(n)?.visible)return null;m.set(n,!0);return{n,l:this.g.getLabelOf(n)||n}}).filter(Boolean).sort((x,y)=>x.l.localeCompare(y.l))},bUI(){const h=\`<div id="\${this.pId}" style="position:fixed;top:5%;left:50%;transform:translateX(-50%);width:90%;max-width:800px;background:#fff;color:#000;border-radius:12px;box-shadow:0 8px 32px #0005;z-index:999999;font-family:sans-serif;display:flex;flex-direction:column;max-height:90vh"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Extractor Builder</h3><div style="padding:20px;overflow-y:auto;flex-grow:1"><p style="font-size:.9em;color:#333;margin:0 0 15px;padding:10px;background:#eef2ff;border-radius:6px;">Click field labels on the form to add them to the extract list.</p><div style="margin-bottom:20px"><h4 style="margin:0 0 10px;font-size:1.1em;">Fields to Extract</h4><div id="\${this.pId}-e"></div></div><div><h4 style="margin:0 0 10px;font-size:1.1em;">Filters (Optional)</h4><div id="\${this.pId}-c"></div><button id="\${this.pId}-add-c" style="margin-top:10px;padding:6px 12px;background:#eef;border:1px solid #ccf;color:#339;border-radius:4px;cursor:pointer">+ Add Filter</button></div></div><div id="\${this.pId}-res" style="display:none;padding:0 20px 20px;"></div><div style="padding:20px;border-top:1px solid #ccc;display:flex;justify-content:flex-end;gap:10px"><button id="\${this.pId}-close">Close</button><button id="\${this.pId}-gen" style="background:#0066cc;color:white;padding:8px 16px;border:none;border-radius:6px">Generate Extractor</button></div></div>\`;this.w.document.body.insertAdjacentHTML('beforeend',h);this.w.document.getElementById(this.pId+'-add-c').onclick=()=>this.addR('c');this.w.document.getElementById(this.pId+'-close').onclick=()=>this.close();this.w.document.getElementById(this.pId+'-gen').onclick=()=>this.genF();this.rR()},rR(){const eC=this.w.document.getElementById(this.pId+'-e'),cC=this.w.document.getElementById(this.pId+'-c'),fO=this.f.map(f=>\`<option value="\${f.n}">\${f.l}</option>\`).join('');eC.innerHTML=this.e.length?this.e.map((f,i)=>this.rE(f,i)).join(''):'<p style="text-align:center;color:#666;font-size:.9em;padding:10px">Click fields to add.</p>';cC.innerHTML=this.c.length?this.c.map((c,i)=>this.rC(c,i,fO)).join(''):'<p style="text-align:center;color:#666;font-size:.9em;padding:10px">No filters. All records will be extracted.</p>'},rE(f,i){return \`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f0f0f0"><span>\${f.l} (\${f.n})</span><button data-i="\${i}" data-t="e" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px">X</button></div>\`},rC(c,i,fO){return \`<div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #f0f0f0"><select data-i="\${i}" data-t="c" data-k="f" style="flex:2;padding:6px;border-radius:4px;border:1px solid #ccc"><option value="">Select Field</option>\${fO.replace('value="'+c.f+'"','value="'+c.f+'" selected')}</select><select data-i="\${i}" data-t="c" data-k="o" style="flex:1;padding:6px;border-radius:4px;border:1px solid #ccc"><option value="c" \${c.o==='c'?'selected':''}>contains</option><option value="d" \${c.o==='d'?'selected':''}>does not contain</option><option value="i" \${c.o==='i'?'selected':''}>is</option><option value="n" \${c.o==='n'?'selected':''}>is not</option><option value="e" \${c.o==='e'?'selected':''}>is empty</option></select><input type="text" value="\${c.v||''}" data-i="\${i}" data-t="c" data-k="v" placeholder="Value" style="flex:2;padding:6px;border-radius:4px;border:1px solid #ccc;\${c.o==='e'?'visibility:hidden;':''}"/><button data-i="\${i}" data-t="c" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px">X</button></div>\`},hE(e){const t=e.target,i=t.dataset.i,type=t.dataset.t;if(!i||!type)return;t.tagName==='BUTTON'?this.rmR(type,i):(this[type][i][t.dataset.k]=t.value,this.rR())},cH(e){if(e.target.closest('#'+this.pId))return;const el=e.target.closest('div.form-group, tr[data-form-type]');if(!el)return;e.preventDefault();e.stopPropagation();const lE=el.querySelector('.control-label, .label-text, .form-label');if(!lE)return;const fN=this.g.getControl(lE.getAttribute('for'))?.name||this.f.find(f=>f.l===lE.textContent.trim())?.name;if(!fN||!this.g.hasField(fN)||this.e.find(f=>f.n===fN))return;this.e.push({n:fN,l:this.g.getLabelOf(fN)||fN});this.rR()},addR(t){this.c.push({f:'',o:'c',v:''});this.rR()},rmR(t,i){this[t].splice(i,1);this.rR()},genF(){this.win.document.querySelectorAll(\`#\${this.pId} [data-i]\`).forEach(el=>{const{i,t,k}=el.dataset;this[t][i]&&(this[t][i][k]=el.value)});if(!this.e.length)return alert('Please select at least one field to extract.');for(const c of this.c){if(c.o==='c'&&!c.v)return alert('Error: A "contains" filter cannot have an empty value.')}const pN=prompt('Enter a name for your extractor bookmarklet:','CSV Export');if(!pN)return;const safeName=pN.replace(/[^a-zA-Z0-9._-]+/g,'_')||'export';const cfg={e:this.e,c:this.c.filter(c=>c.f)};const headers=JSON.stringify(cfg.e.map(f=>f.l));const fieldNames=JSON.stringify(cfg.e.map(f=>f.n));const runL=this.bL(cfg);const b=\`javascript:(async()=>{const findEnv=w=>{try{function findFS(n){let f=n.querySelector('#gsft_main,iframe[name="gsft_main"]');if(f)return f;const a=n.querySelectorAll('*');for(const e of a)if(e.shadowRoot&&(f=findFS(e.shadowRoot)))return f;return null}function getE(t){if(!t)return null;const l=t.document.querySelector('#task_table,.list_table,[data-list_id]');if(l)return{type:'list',ctx:{w:t,l}};return null}const fe=findFS(w.document);if(fe&&fe.contentWindow){const fv=getE(fe.contentWindow);if(fv)return fv}return getE(w)}catch(e){}return null},runL=\${runL},env=findEnv(window.top);if(!env||env.type!=='list')return alert('Run this extractor on a list view.');const{w:wC,l:lE}=env.ctx,tN=lE.getAttribute('glide_table')||'task',aT=[...wC.document.querySelectorAll('tr[sys_id]')].map(r=>r.getAttribute('sys_id')).filter(Boolean);if(!aT.length)return alert('No tickets found in list.');const mI='sn-modal-'+Date.now(),mE=document.createElement('div');mE.id=mI,mE.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:#0008;z-index:99999;display:flex;align-items:center;justify-content:center;font-family:sans-serif;',mE.innerHTML=\\\`<div style="width:90%;max-width:500px;margin:auto;background:#fff;color:#000;border-radius:12px;"><h3 style="margin:0;padding:20px;background:#0066cc;color:#fff;border-radius:12px 12px 0 0">Exporting Data</h3><div id="\${mI}-content" style="padding:20px;"></div></div>\\\`,document.body.appendChild(mE);const mo={content:document.getElementById(mI+'-content'),close:()=>{document.getElementById(mI)&&mE.remove()}},cMF=(u,rj)=>{const fr=document.createElement('iframe');fr.style.cssText='position:absolute;left:-9999px;width:1px;height:1px;border:none;';const cl=()=>{clearTimeout(to),fr.onload=null,fr.onerror=null,fr.parentNode&&fr.parentNode.removeChild(fr)},to=setTimeout(()=>{cl(),rj(new Error('Timeout'))},8000);return document.body.appendChild(fr),fr.src=u,{frame:fr,cleanup:cl}},gTD=sI=>new Promise((rs,rj)=>{const u=\\\`/\${tN}.do?sys_id=\${sI}&sysparm_nostack=true\\\`,{frame:fr,cleanup:cl}=cMF(u,rj);fr.onload=async()=>{try{const fE=await(w=>new Promise((r,e)=>{let a=0;(function t(){w&&w.g_form?r(w.g_form):a++<50?setTimeout(t,100):e(new Error('g_form NA'))})()}))(fr.contentWindow);rs(runL(fE))}catch(e){console.warn('Skipping ticket \${sI}:',e);rs(null)}finally{cl()}},fr.onerror=()=>{cl(),rj(new Error('Frame load error'))}}),pTP=async tI=>{const re=[];for(let i=0;i<tI.length;i+=5){const bt=tI.slice(i,i+5),br=await Promise.allSettled(bt.map(id=>gTD(id)));re.push(...br);mo.content.innerHTML='<p>Processing...('+re.length+'/'+tI.length+')</p>'}return re};const results=await pTP(aT);const data=results.filter(r=>r.status==='fulfilled'&&r.value).map(r=>r.value);if(!data.length){mo.content.innerHTML='<p>No records matched the filters or could be processed.</p><button onclick="this.parentElement.parentElement.remove()">Close</button>';return}const eC=v=>{const s=String(v==null?'':v);return/[",\\\\n\\\\r]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s};const headers=\${headers};const fieldNames=\${fieldNames};const rows=[headers.map(eC).join(',')];data.forEach(r=>{const v=fieldNames.map(n=>r[n]);rows.push(v.map(eC).join(','))});const csv=rows.join('\\\\n'),blob=new Blob([String.fromCharCode(65279),csv],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a'),url=URL.createObjectURL(blob);link.href=url,link.download='\${safeName}'+'.csv',document.body.appendChild(link),link.click(),document.body.removeChild(link),URL.revokeObjectURL(url),mo.content.innerHTML=\`<p style="color:green;font-weight:bold;">Export Complete!</p><p>\${data.length} record(s) exported.</p><button onclick="this.parentElement.parentElement.remove()">Close</button>\`})()\`;const resEl=this.w.document.getElementById(this.pId+'-res');resEl.innerHTML=\`<h4>Extractor Ready</h4><p>Drag this link to your bookmarks bar, then run it on a list view.</p><a href='\${b.replace(/'/g,"&apos;").replace(/"/g,"&quot;")}' style="display:inline-block;padding:10px 20px;background:#28a745;color:white;border-radius:5px;text-decoration:none;">\${pN}</a>\`;resEl.style.display='block'},bL(cfg){let l='try{let pass=!0;';cfg.c.forEach(c=>{const v=c.v.replace(/'/g,"\\\\'");switch(c.o){case'c':l+=\`if(!g.getValue('\${c.f}').toLowerCase().includes('\${v}'.toLowerCase()))pass=!1;\\\`;break;case'd':l+=\`if(g.getValue('\${c.f}').toLowerCase().includes('\${v}'.toLowerCase()))pass=!1;\\\`;break;case'i':l+=\`if(g.getValue('\${c.f}')!='\${v}')pass=!1;\\\`;break;case'n':l+=\`if(g.getValue('\${c.f}')=='\${v}')pass=!1;\\\`;break;case'e':l+=\`if(g.getValue('\${c.f}'))pass=!1;\\\`;break}});l+='if(!pass)return null;const data={};';cfg.e.forEach(f=>{l+=\`data['\${f.n}']=g.getValue('\${f.n}');\\\`});l+='return data;}catch(e){console.warn("Field not found, skipping record.", e.message); return null;}' ;return \`function(g){\${l}}\`},close(){this.w.document.removeEventListener('click',this.cB,true);this.w.document.getElementById(this.pId)?.remove()},bindEvts(){this.cB=this.cH.bind(this);this.w.document.addEventListener('click',this.cB,true);this.hB=this.hE.bind(this);this.w.document.getElementById(this.pId).addEventListener('change',this.hB);this.w.document.getElementById(this.pId).addEventListener('click',this.hB)}};b.init();b.bindEvts()})()`;

    const link = document.getElementById('bookmarklet-link');
    link.href = builderScript;
    link.textContent = name;
    
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
});

document.getElementById('startOverBtn').addEventListener('click', () => {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
});
</script>
</body>
</html>


